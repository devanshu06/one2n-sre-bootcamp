name: CI Pipeline

on:
  push:
    paths:
      - 'milestone-4/**'
  pull_request:
    paths:
      - 'milestone-4/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set build tag
        id: vars
        run: |
          # Extract the latest tag
          LATEST_TAG=$(git describe --tags `git rev-list --tags --max-count=1`)
          echo "Latest tag: $LATEST_TAG"
          
          # Split the version number into its components
          IFS='.' read -r -a VERSION_PARTS <<< "${LATEST_TAG:-0.0.0}"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"

          # Increment the patch version
          PATCH=$((PATCH + 1))
          NEW_TAG="$MAJOR.$MINOR.$PATCH"
          
          echo "New tag: $NEW_TAG"
          
          # Set the new tag in the environment
          echo "BUILD_TAG=$NEW_TAG" >> $GITHUB_ENV

      - name: Lint code
        run: |
          cd milestone-4
          make lint

      - name: Docker login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker image
        run: |
          cd milestone-4
          docker build -t dev06/one2n-sre-bootcamp:${{ env.BUILD_TAG }} .

      - name: Push Docker image
        run: |
          cd milestone-4
          docker push dev06/one2n-sre-bootcamp:${{ env.BUILD_TAG }}

      - name: Update application image tag in values.yml
        run: |
          cd milestone-8/application-stack
          yq eval '.application.dep.image.tag = strenv(BUILD_TAG)' -i values.yaml

      - name: Commit and push updated values.yml
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          git config user.name 'github-actions'
          git config user.email 'github-actions@github.com'
          cd milestone-8/application-stack
          git add values.yaml
          git commit -m "Update application Docker image tag to ${{ env.BUILD_TAG }}"
          
          # Capture the current branch name
          CURRENT_BRANCH=$(git symbolic-ref --short HEAD)
          echo "Current branch: $CURRENT_BRANCH"
          
          # Push the changes to the current branch
          git remote set-url origin https://${{ secrets.PAT }}@github.com/devanshu06/one2n-sre-bootcamp
          git push origin HEAD:$CURRENT_BRANCH
